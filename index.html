<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重要度スコア・シグナルビューア</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Noto Sans JP Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* フォント設定 */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc; /* Tailwind bg-gray-50 */
        }

        /* ローディングスピナー */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue 500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* 概要表示エリア用のスタイル */
        .summary-content {
            display: none; /* 初期状態は非表示 */
            border-top: 1px solid #e5e7eb; /* 境界線 */
            padding-top: 12px;
            margin-top: 12px;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                重要度スコア・シグナルビューア
            </h1>
            <!-- <p>...</p> の説明文を削除 -->
        </header>

        <!-- フィルタコントロール -->
        <div id="filter-controls" class="mb-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- キーワード検索 (Title) -->
                <div>
                    <label for="filter-keyword" class="block text-sm font-medium text-gray-700">記事タイトル:</label>
                    <input type="text" id="filter-keyword" name="filter-keyword" placeholder="キーワードを入力..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <!-- レンズフィルタ (H列) -->
                <div>
                    <label for="lens-filter" class="block text-sm font-medium text-gray-700">カテゴリ:</label>
                    <select id="lens-filter" name="lens-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="all">すべてのカテゴリ</option>
                        <!-- オプションはJSで動的に追加 -->
                    </select>
                </div>
                <!-- 日付フィルタ (D列) -->
                <div>
                    <label for="date-filter" class="block text-sm font-medium text-gray-700">公開日時:</label>
                    <select id="date-filter" name="date-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="all">すべて</option>
                        <option value="today">本日</option>
                        <option value="week" selected>直近1週間以内</option>
                        <option value="month">直近1か月以内</option>
                        <option value="3month">直近3か月以内</option>
                        <option value="6month">直近半年以内</option>
                        <option value="year">直近1年以内</option>
                    </select>
                </div>
            </div>
            <!-- リセットボタン -->
            <div class="mt-4 text-right">
                <button id="filter-reset" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    フィルタをリセット
                </button>
            </div>
        </div>

        <!-- スコア凡例 (新規追加) -->
        <div id="score-legend" class="mb-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
            <h4 class="text-sm font-bold text-gray-700 mb-2">スコア凡例 (判定目安)</h4>
            <div class="flex flex-col sm:flex-row sm:flex-wrap gap-x-4 gap-y-2">
                <div class="flex items-center space-x-2">
                    <span class="flex-shrink-0 w-4 h-4 rounded-full bg-red-100 ring-1 ring-red-200"></span>
                    <span class="text-sm text-red-600 font-medium">5.0 以上: 優先度高</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="flex-shrink-0 w-4 h-4 rounded-full bg-yellow-100 ring-1 ring-yellow-200"></span>
                    <span class="text-sm text-yellow-700 font-medium">3.5 – 4.9: 優先度中</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="flex-shrink-0 w-4 h-4 rounded-full bg-blue-100 ring-1 ring-blue-200"></span>
                    <span class="text-sm text-blue-600 font-medium">3.4 以下: 優先度低</span>
                </div>
            </div>
        </div>

        <!-- ローディング表示 -->
        <div id="loading" class="flex flex-col items-center justify-center py-16">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600">データを読み込んでいます...</p>
        </div>

        <!-- エラー表示 -->
        <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
            <strong class="font-bold">エラー:</strong>
            <span id="error-message" class="block sm:inline"></span>
        </div>

        <!-- データリスト -->
        <div id="signals-list" class="space-y-4">
            <!-- データはJSによってここに挿入されます -->
        </div>

    </div>

    <script>
        // --- 定数 ---
        const SPREADSHEET_ID = '1kJDx3xxY7lX6mFfHeY2vSBPqUILcHhIY6ncNTCHACQ4';
        const GID = '581566144';
        const API_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json`;

        const GEMINI_API_KEY = ""; // Canvasが自動挿入
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;


        // --- DOM要素 ---
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const errorMessageEl = document.getElementById('error-message');
        const listEl = document.getElementById('signals-list');
        
        // フィルタUIの要素 (変更)
        const filterKeywordEl = document.getElementById('filter-keyword');
        const lensFilterEl = document.getElementById('lens-filter');
        const dateFilterEl = document.getElementById('date-filter');
        const filterResetBtn = document.getElementById('filter-reset');

        // --- グローバル変数 ---
        let allSignalsData = []; // 全データを保持する配列

        // --- メイン処理 ---
        window.addEventListener('DOMContentLoaded', () => {
            fetchData();

            // フィルタUIにイベントリスナーを設定 (変更)
            filterKeywordEl.addEventListener('input', applyFiltersAndDisplay);
            lensFilterEl.addEventListener('change', applyFiltersAndDisplay);
            dateFilterEl.addEventListener('change', applyFiltersAndDisplay);
            
            filterResetBtn.addEventListener('click', () => {
                filterKeywordEl.value = '';
                lensFilterEl.value = 'all';
                dateFilterEl.value = 'week'; // リセット時は「1週間以内」に戻す
                applyFiltersAndDisplay();
            });
        });

        /**
         * データをフェッチして処理する
         */
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);

                const parsedData = parseSheetData(data.table);
                allSignalsData = parsedData;
                
                // (新規) レンズフィルタのオプションを設定
                setupLensFilter();

                // 初回表示（フィルタ適用）
                applyFiltersAndDisplay();

            } catch (err) {
                console.error('データの取得に失敗しました:', err);
                showError('データの取得に失敗しました。シートが公開されているか確認してください。');
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        /**
         * (新規) H列のレンズ（カテゴリ）一覧をフィルタに設定する
         */
        function setupLensFilter() {
            // allSignalsDataからユニークなlens名を取得し、ソートする
            const uniqueLenses = [...new Set(allSignalsData.map(item => item.lens))]
                                 .filter(lens => lens !== '分類なし') // 「分類なし」を除外
                                 .sort(); 
            
            // 既存のオプション（"すべてのレンズ"以外）をクリア
            Array.from(lensFilterEl.options).forEach(option => {
                if (option.value !== 'all') {
                    option.remove();
                }
            });

            // ユニークなlens名をオプションとして追加
            uniqueLenses.forEach(lens => {
                const option = document.createElement('option');
                option.value = lens;
                option.textContent = lens;
                lensFilterEl.appendChild(option);
            });
        }

        /**
         * (修正) フィルタとソートを適用してデータを表示する
         */
        function applyFiltersAndDisplay() {
            // 1. フィルタ条件を取得
            const keyword = filterKeywordEl.value.toLowerCase().trim();
            const selectedLens = lensFilterEl.value;
            const selectedDateRange = dateFilterEl.value;

            // (修正) 2. 日付フィルタ
            const { startDate } = getDateRange(selectedDateRange);
            
            let filteredData = allSignalsData.filter(item => {
                // 日付フィルタ（日付が不正なデータは除外）
                if (!item.published) return false;
                if (startDate && item.published < startDate) {
                    return false;
                }
                return true;
            });

            // (修正) 3. キーワードフィルタ (Titleのみ)
            if (keyword) {
                filteredData = filteredData.filter(item => 
                    item.title.toLowerCase().includes(keyword)
                );
            }
            
            // (新規) 4. レンズフィルタ (H列)
            if (selectedLens !== 'all') {
                filteredData = filteredData.filter(item => 
                    item.lens === selectedLens
                );
            }
            
            // 5. スコアで降順ソート
            filteredData.sort((a, b) => b.score - a.score);

            // 6. データを表示
            displayData(filteredData);
        }

        /**
         * Google gvizのtableデータを解析してオブジェクトの配列に変換する
         * @param {object} table - Google gvizのtableオブジェクト
         * @returns {Array<object>}
         */
        function parseSheetData(table) {
            // 必要な列のインデックス（列番号）を特定 (ID 'A', 'B', 'C'...)
            const findIndexById = (id) => table.cols.findIndex(col => col.id === id);
            
            const titleIndex = findIndexById('E');
            const urlIndex = findIndexById('F');
            const publishedIndex = findIndexById('D');
            const lensIndex = findIndexById('H');
            const domainIndex = findIndexById('I');
            const scoreIndex = findIndexById('K');

            // 必須列のチェック
            if ([titleIndex, urlIndex, publishedIndex, lensIndex, domainIndex, scoreIndex].some(index => index === -1)) {
                const missing = [
                    titleIndex === -1 ? 'Title (E列)' : '',
                    urlIndex === -1 ? 'Url (F列)' : '',
                    publishedIndex === -1 ? 'Published (D列)' : '',
                    lensIndex === -1 ? 'Lens (H列)' : '',
                    domainIndex === -1 ? 'Domain (I列)' : '',
                    scoreIndex === -1 ? 'Score (K列)' : ''
                ].filter(Boolean).join(', ');
                throw new Error(`必須列が見つかりません: ${missing}`);
            }

            return table.rows.map(row => {
                const cells = row.c;
                
                const score = cells[scoreIndex] ? parseFloat(cells[scoreIndex].v) : NaN;
                if (isNaN(score)) return null;
                
                const gvizDateString = cells[publishedIndex] ? cells[publishedIndex].v : null;
                const publishedDate = gvizDateString ? parseGvizDate(gvizDateString) : null;
                
                return {
                    title: cells[titleIndex] ? (cells[titleIndex].v || 'タイトルなし') : 'タイトルなし',
                    url: cells[urlIndex] ? (cells[urlIndex].v || '#') : '#',
                    published: publishedDate,
                    lens: cells[lensIndex] ? (cells[lensIndex].v || '分類なし') : '分類なし',
                    domain: cells[domainIndex] ? (cells[domainIndex].v || 'ドメイン不明') : 'ドメイン不明',
                    score: score
                };
            }).filter(item => item !== null);
        }

        /**
         * (修正) 処理済みデータをHTMLとしてリストに表示する
         * @param {Array<object>} data
         */
        function displayData(data) {
            if (data.length === 0) {
                // フィルタ条件によってメッセージを変更
                if (filterKeywordEl.value || lensFilterEl.value !== 'all' || dateFilterEl.value !== 'all') {
                    listEl.innerHTML = '<p class="text-gray-600 text-center py-8">該当するシグナルはありません。</p>';
                } else {
                    listEl.innerHTML = '<p class="text-gray-600 text-center py-8">表示するデータがありません。</p>';
                }
                return;
            }

            const htmlItems = data.map((item, index) => {
                const { scoreColor, scoreTextColor } = getScoreStyling(item.score);
                const scoreLabel = item.lens; 
                const publishedFormatted = item.published ? formatDate(item.published) : '日付不明';

                const summaryButtonId = `summary-btn-${index}`;
                const summaryContentId = `summary-content-${index}`;

                return `
                <div class="bg-white shadow-md rounded-lg border border-gray-200 overflow-hidden">
                    <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="block transition duration-200 ease-in-out transform hover:bg-gray-50">
                        <article class="p-5 flex items-start space-x-4">
                            
                            <!-- スコア表示 (Left) -->
                            <div class="flex-shrink-0 flex flex-col items-center w-20 text-center">
                                <div class="px-2 py-0.5 rounded-full text-xs font-semibold ${scoreColor} ${scoreTextColor} truncate" title="${scoreLabel}">
                                    ${scoreLabel}
                                </div>
                                <div class="mt-2 text-3xl font-bold ${scoreTextColor}">
                                    ${item.score.toFixed(1)}
                                </div>
                            </div>

                            <!-- 記事内容 (Right) -->
                            <div class="flex-grow min-w-0">
                                <h3 class="text-lg font-bold text-gray-800 break-words">
                                    ${item.title}
                                </h3>
                                <div class="mt-2 flex items-center text-sm text-gray-500 space-x-3">
                                    <!-- Domain -->
                                    <svg class="flex-shrink-0 w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
                                    </svg>
                                    <span class="truncate" title="${item.domain}">${item.domain}</span>
                                    
                                    <span class="text-gray-300">|</span>

                                    <!-- Published Date -->
                                    <svg class="flex-shrink-0 w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                                    </svg>
                                    <span>${publishedFormatted}</span>
                                </div>
                            </div>
                        </article>
                    </a>
                    
                    <!-- 概要生成エリア -->
                    <div class="px-5 pb-4">
                        <button 
                            id="${summaryButtonId}"
                            data-title="${encodeURIComponent(item.title)}" 
                            data-target-id="${summaryContentId}"
                            class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                        >
                            記事の概要を生成 (Gemini)
                        </button>
                        <div id="${summaryContentId}" class="summary-content text-gray-700 text-sm mt-3 pt-3 border-t border-gray-200" style="display: none;">
                            <!-- 概要はここに挿入されます -->
                        </div>
                    </div>
                </div>
                `;
            });

            listEl.innerHTML = htmlItems.join('');
            addSummaryButtonListeners();
        }

        /**
         * 概要生成ボタンにイベントリスナーを設定する
         */
        function addSummaryButtonListeners() {
            const summaryButtons = document.querySelectorAll('[id^="summary-btn-"]');
            summaryButtons.forEach(button => {
                button.replaceWith(button.cloneNode(true));
                const newButton = document.getElementById(button.id);
                newButton.addEventListener('click', handleSummaryClick);
            });
        }

        /**
         * 概要生成ボタンがクリックされたときの処理
         * (中身は変更なし)
         */
        async function handleSummaryClick(event) {
            const button = event.currentTarget;
            const targetId = button.dataset.targetId;
            const articleTitle = decodeURIComponent(button.dataset.title);
            const contentEl = document.getElementById(targetId);

            if (!contentEl) return;
            if (button.disabled) return;

            if (contentEl.style.display === 'block') {
                contentEl.style.display = 'none';
                button.textContent = '記事の概要を生成 (Gemini)';
                return;
            }

            button.disabled = true;
            button.textContent = '生成中...';
            contentEl.style.display = 'block';
            contentEl.innerHTML = '<div class="flex justify-center items-center"><div class="loader !w-6 !h-6"></div></div>'; 

            try {
                const summary = await generateSummaryWithGemini(articleTitle);
                contentEl.innerHTML = summary.replace(/\n/g, '<br>');
                button.textContent = '概要を隠す';
            } catch (error) {
                console.error('概要生成エラー:', error);
                contentEl.innerHTML = `<p class="text-red-600">概要の生成に失敗しました。時間をおいて再試行してください。</p>`;
                button.textContent = '再試行 (Gemini)';
            } finally {
                button.disabled = false;
            }
        }

        /**
         * Gemini API (タイトルベース) を呼び出して記事の概要を生成する
         * (中身は変更なし)
         */
        async function generateSummaryWithGemini(articleTitle) {
            const prompt = `以下の記事タイトルを読み、想定される記事の内容を日本語で3～4文程度の簡潔な概要として作成してください。\n\nタイトル: ${articleTitle}`;
            
            const payload = {
                contents: [{ 
                    parts: [{ text: prompt }] 
                }],
                systemInstruction: {
                    parts: [{ text: "あなたはプロの編集者です。提供された記事タイトルから、その記事で述べられているであろう内容を推測し、簡潔な概要を作成してください。" }]
                },
            };

            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000; 

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`API Error ${response.status}: Retrying...`);
                        }
                        const errorData = await response.json();
                        throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        return text;
                    } else {
                        throw new Error('APIから有効なテキスト応答がありませんでした。');
                    }

                } catch (error) {
                    console.warn(error.message);
                    attempts++;
                    if (attempts >= maxAttempts) {
                        throw new Error(`API呼び出しに失敗しました（${maxAttempts}回リトライ後）。`);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, attempts - 1)));
                }
            }
            throw new Error('概要の生成に失敗しました。');
        }


        /**
         * スコアに基づいたTailwindクラスを返す
         * (中身は変更なし)
         */
        function getScoreStyling(score) {
            if (score >= 5.0) {
                return {
                    scoreColor: 'bg-red-100',
                    scoreTextColor: 'text-red-600'
                };
            } else if (score >= 3.5) {
                return {
                    scoreColor: 'bg-yellow-100',
                    scoreTextColor: 'text-yellow-700'
                };
            } else {
                return {
                    scoreColor: 'bg-blue-100',
                    scoreTextColor: 'text-blue-600'
                };
            }
        }

        /**
         * エラーメッセージを表示する
         * (中身は変更なし)
         */
        function showError(message) {
            errorMessageEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // --- ヘルパー関数 ---

        /**
         * (新規) 選択された日付範囲に基づいて開始日を計算する
         * @param {string} rangeKey - 'today', 'week', 'month', '3month', '6month', 'year', 'all'
         * @returns {object} - { startDate: Date | null }
         */
        function getDateRange(rangeKey) {
            const now = new Date();
            // 今日の午前0時に設定
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            let startDate = null;

            switch (rangeKey) {
                case 'today':
                    startDate = startOfToday;
                    break;
                case 'week':
                    // 1週間前 (6日前) の午前0時
                    startDate = new Date(startOfToday.getTime() - 6 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    // 1か月前の日付
                    startDate = new Date(startOfToday.getFullYear(), startOfToday.getMonth() - 1, startOfToday.getDate());
                    break;
                case '3month':
                    startDate = new Date(startOfToday.getFullYear(), startOfToday.getMonth() - 3, startOfToday.getDate());
                    break;
                case '6month':
                    startDate = new Date(startOfToday.getFullYear(), startOfToday.getMonth() - 6, startOfToday.getDate());
                    break;
                case 'year':
                    startDate = new Date(startOfToday.getFullYear() - 1, startOfToday.getMonth(), startOfToday.getDate());
                    break;
                case 'all':
                default:
                    startDate = null; // すべて (フィルタなし)
                    break;
            }
            return { startDate };
        }

        /**
         * gvizの "Date(YYYY,MM,DD,HH,MM,SS)" 形式の文字列を Date オブジェクトに変換
         * (中身は変更なし)
         */
        function parseGvizDate(gvizDate) {
            try {
                const parts = gvizDate.substring(5, gvizDate.length - 1).split(',');
                const [year, month, day, hour, minute, second] = parts.map(p => parseInt(p, 10));
                return new Date(year, month, day, hour || 0, minute || 0, second || 0);
            } catch (e) {
                console.error('日付のパースに失敗:', gvizDate, e);
                return null;
            }
        }

        /**
         * Dateオブジェクトを "YYYY/MM/DD HH:mm" 形式の文字列にフォーマットする
         * (中身は変更なし)
         */
        function formatDate(dateObj) {
            if (!dateObj) return '日付不明';
            return new Intl.DateTimeFormat('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).format(dateObj);
        }

    </script>
</body>
</html>

